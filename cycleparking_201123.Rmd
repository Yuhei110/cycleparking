---
title: "cycleparking"
author: "Yuhei Ito"
date: "2020/10/7"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Change language settings.
Sys.setenv(LANG = "en")
Sys.setlocale("LC_ALL","English")

# Load necessary packages.
library(dplyr)
library(ggplot2)
library(e1071) # for calculating skewness.
library(tmap) # for static and interactive maps.
library(tmaptools) # for color brewer.
library(sf) # for working with vector file.
library(RColorBrewer) # for 

```

## Read me
### input data
census.rda: A census data of 2011 subsetting by Greater London.
route.rda: route data obtained from PCT.
parking.rda: parking data merged from CID and OSM.
lsoa_msoa.rda: LSOA and MSOA link.

## Load data
```{r}
# Load census data.
census = paste(getwd(),"/data/census.rda", sep = "")
load(census)

# Load route data.
route = paste(getwd(),"/data/route.rda", sep = "")
load(route)

# Load parking data.
parking = paste(getwd(),"/data/parking.rda", sep = "")
load(parking)

# Load area data.
area = paste(getwd(),"/data/area.rda", sep = "")
load(area)

# Load lsoa_msoa data.
lsoa_msoa = paste(getwd(),"/data/lsoa_msoa.rda", sep = "")
load(lsoa_msoa)

# MSOA shapefile.
msoa = st_read("C:\\Users\\yuhei\\Documents\\R\\cycleparking\\data\\msoa.shp")
```

## Join MSOA code to census
```{r}
# Join Origin MSOA
census = left_join(census, lsoa_msoa, by = c("olsoa" = "lsoa"))
any(is.na(census$msoa)) # False, join successful.
census$omsoa = census$msoa
census = census[,c("olsoa","omsoa","dlsoa","all","bicycle")]

# Join Destination MSOA
census = left_join(census, lsoa_msoa, by = c("dlsoa" = "lsoa"))
any(is.na(census$msoa)) # False, join successful.
census$dmsoa = census$msoa
census = census[,c("olsoa","omsoa","dlsoa","dmsoa","all","bicycle")]
```

## Join MSOA code to parking
```{r}
parking = left_join(parking, lsoa_msoa, by = c("lsoa" = "lsoa"))
any(is.na(parking$msoa)) # False, join successful.
parking = parking[,c("lsoa","msoa","space")]
```

## Aggregate census' all and bicycle by MSOA.
```{r}
census2 = 
  census %>%
  group_by(omsoa,dmsoa)%>%
  summarise(all = sum(all), bicycle = sum(bicycle))

sum(census2$all) == sum(census$all) #TRUE, successful.
```

## Add distance and hilliness to census2.
```{r}
# Delete rows with rf_dist_km and rf_avslope_perc are NA. These NA rows have Other or OD0000003 written on geo_code2 column.
route = 
  route %>%
  filter(!is.na(rf_dist_km))
any(is.na(route)) #FALSE, successful.

# CREATE JOIN ID.
# 1. Create join ID for Origin = geo_code1, Destination = geo_code2, ID = OD
route12 = route
route12$id = paste(route$geo_code1, route$geo_code2)
nrow(route12) #308782

# 2. Create join ID for Origin = geo_code2, Destination = geo_code1, ID = OD
route21 = route
route21$id = paste(route$geo_code2, route$geo_code1)
nrow(route21) #308782

# 3. Combine two dfs.
route = rbind(route12,route21)
nrow(route) #617564

# Remove duplication of ID which are intra-zonal OD pairs. Avoid adding duplicated rows when joining to census data.
route = 
  route %>% distinct(id, .keep_all = TRUE)

# Delete unnecessary column
route = route[,c("id", "rf_dist_km", "rf_avslope_perc")]
```

## Join distance and hilliness to census2.
```{r}
# Create join id for Census data.
census2$id = paste(census2$omsoa, census2$dmsoa)

# Join route data.
census2 = left_join(census2, route, by = "id")

# Delete id column
census2 = 
  census2 %>%
  select(-id)

any(is.na(census2)) #TRUE
  census2 %>%
  filter(is.na(rf_dist_km))
```

## Check census data.
```{r}
# Check if there is any No fixed place data on Census. -> No.
nrow(census2) #601902 rows.

census2 %>%
  mutate(First3D = substring(dmsoa,1,3)) %>% # Obtain first three letters of destination MSOA.
  filter(First3D == "E02") # Check if all rows are E02. 601902 rows Correct.

census2 %>%
  mutate(First3O = substring(omsoa,1,3)) %>% # Obtain first three letters of origin MSOA.
  group_by(First3O)%>%
  summarise(n(),sum(all),sum(bicycle)) # There are 4570 (bicycle n=97) commuters come from Wales.

# Identify intra-zonal trip.
census2$intra = ifelse(census2$omsoa == census2$dmsoa, TRUE, FALSE)
census2 %>%
  filter(intra == TRUE) %>%
  nrow() #983 rows

# Excluded rows?
census2$excluded = ifelse(is.na(census2$rf_dist_km), TRUE, FALSE)
```

## Check how many trips are excluded and how many are intra/inter zonal trips. (Table 6. Number of Commuters in/to Greater London) 
```{r}
# Total amount of travel to GL before excluding any trips.
sum(census2$all) # 3715982

# Intra and Inter zonal trips
census2 %>%
  group_by(intra) %>%
  summarise(n(),sum(all), sum(bicycle))

# Excluded and Included to the study.
census2 %>%
  group_by(excluded) %>%
  summarise(n(),sum(all), sum(bicycle))

# Intra/Inter and Exclude/Include.
census2 %>%
  group_by(excluded, intra) %>%
  summarise(n(),sum(all), sum(bicycle))

219452/nrow(census2)*100      # 36% OD pairs
570254/sum(census2$all)*100   # 15% all commuters
4017/sum(census2$bicycle)*100 # 3%  cycle commuters
```

## BCG construction Step 1: Eliminating >30km od and CalculateGoDutch propensity
```{r}
# Eliminate >30km OD pairs
census2 =
  census2 %>% #601902 od pairs
  filter(excluded == FALSE) %>% #382450 od pairs
  select(-c("excluded"))

# Calculate parameter for Go Dutch.
census2 =
  census2 %>%
  mutate(logit_gd = 
           -3.959 + 
           (-0.5963 * rf_dist_km) + 
           (1.866 * sqrt(rf_dist_km)) + 
           (0.008050 * rf_dist_km^2) +
           (-0.2710 * rf_avslope_perc) + 
           (0.009394 * rf_dist_km*rf_avslope_perc) + 
           (-0.05135 * sqrt(rf_dist_km) *rf_avslope_perc) +
           2.523 +
           (-0.07626*rf_dist_km)
         ) 

# Calculate GD propensity.
census2$GDpct = exp(census2$logit_gd) / (1 + exp(census2$logit_gd))
```

## BCG construction Step 2: Calculate GoDutch number of cycle commuters for each OD pair.
```{r}
# Calculate future cycle commuter no. based on Go Dutch scenario.
census2 =
  census2%>%
  mutate(bicycle_gd = all*GDpct)

# Check
census2 %>%
  mutate(check = bicycle_gd > bicycle) %>%
  group_by(check) %>%
  summarise(n())
#FALSE	22467	OD pairs have already achieved Dutch propensity.		
#TRUE	359983	

census2 %>%
  filter(bicycle > bicycle_gd) %>%
  arrange(desc(bicycle)) %>%
  nrow() #22467

nrow(census2) #382450

22467/382450 #0.05874493

census2 %>%
  mutate(OverDutch = ifelse(bicycle > bicycle_gd,TRUE, FALSE)) %>%
  group_by(OverDutch)%>%
  summarise(bicycle = sum(bicycle), bicycle_gd = sum(bicycle_gd))

41567- 21290 #20277

# Actual future share is assumed to be unchanged for OD pairs which already achieved the Dutch propensity.
census2$bicycle_future =
  ifelse(census2$bicycle_gd > census2$bicycle,
         census2$bicycle_gd,
         census2$bicycle)

# Rearrange columns
names(census2)

census2 = 
  census2[,c("omsoa","dmsoa","all","bicycle","bicycle_future","bicycle_gd","GDpct","logit_gd","rf_dist_km","rf_avslope_perc","intra")]
```

## BCG construction Step 3: Aggregate by destination MSOA.
```{r}
# Aggregate based on destination MSOA.
census3 =
  census2 %>%
  select(c(1:7))%>%
  group_by(dmsoa)%>%
  summarise(all = sum(all),
            bicycle = sum(bicycle),
            bicycle_future = sum(bicycle_future),
            bicycle_gd = sum(bicycle_gd))

# How many MSOAs in GL?
length(unique(census2$dmsoa)) #983

# Check
sum(census2$all) == sum(census3$all) # TRUE
sum(census2$bicycle) == sum(census3$bicycle) # TRUE
sum(census2$bicycle_future) == sum(census3$bicycle_future) # TRUE
sum(census2$bicycle_gd) == sum(census3$bicycle_gd) # TRUE
```

## BCG construction Step 4: Construct BCG by mean values - Growth Share version
```{r}
# Calculate current share for each MSOA
census3$CurrentShare = census3$bicycle/census3$all

# Calculate future share for each LSOA.
census3$FutureShare = census3$bicycle_future/census3$all

# Calculate growth share and add a new column.
census3$Growth = census3$FutureShare - census3$CurrentShare

# Horizontal axis (Current AT share)
# If the share is lower than the mean, 1 otherwise 2.

BCG_x = ifelse(
  census3$CurrentShare < mean(census3$CurrentShare),
  1,2)

# Vertical axis (Growth AT share)
# If the share is lower than the mean, 1 otherwise 2.

BCG_y = ifelse(
  census3$Growth < mean(census3$Growth),
  1,2)

# Combine the above two.
BCG = paste(BCG_x,BCG_y,sep="")

# Rename the codes to BCG terms.
BCG = recode(BCG, 
              '11' = "Problematic", 
              '12' = "Promising",
              '21' = "Achieved",
              '22' = "Maturing")

# Add a column.
census3$BCG = BCG

census3$BCG = factor(census3$BCG, 
                levels = c("Achieved","Maturing","Promising","Problematic"))

# Current, Future Share and growth max.
max(census3$CurrentShare) #0.148398
max(census3$FutureShare) #0.3400569
max(census3$Growth) #0.3242483
```

## BCG construction Step 5: Construct BCG by mean values - Growth amount version
```{r}
# Calculate growth amount and add a new column.
census3$GrowthNos = census3$bicycle_future - census3$bicycle

# Horizontal axis (Current AT share)
# If the share is lower than the mean, 1 otherwise 2.

BCG_x = ifelse(
  census3$CurrentShare < mean(census3$CurrentShare),
  1,2)

# Vertical axis (Growth AT share)
# If the share is lower than the mean, 1 otherwise 2.

BCG_y = ifelse(
  census3$GrowthNos < mean(census3$GrowthNos),
  1,2)

# Combine the above two.
BCG = paste(BCG_x,BCG_y,sep="")

# Rename the codes to BCG terms.
BCG = recode(BCG, 
              '11' = "Problematic", 
              '12' = "Promising",
              '21' = "Achieved",
              '22' = "Maturing")

# Add a column.
census3$BCGNos = BCG

census3$BCGNos = factor(census3$BCGNos, 
                levels = c("Achieved","Maturing","Promising","Problematic"))

# Current, Future Share and growth max.
max(census3$CurrentShare) #0.148398
max(census3$FutureShare) #0.3400569
max(census3$GrowthNos) #0.3242483

census3[,c("GrowthNos", "BCGNos")]

tbd= census3[,c("GrowthNos", "BCGNos")]
tbd$BCG_y = BCG_y
rm(tbd)
```

# Government Target Equity 

## BCG construction Step 1: Eliminating >30km od and Calculate Government Target Equity (GE) propensity
```{r}
# Calculate parameter for Government Target Equity (GE).
census2 =
  census2 %>%
  mutate(logit_ge = 
           -3.959 + 
           (-0.5963 * rf_dist_km) + 
           (1.866 * sqrt(rf_dist_km)) + 
           (0.008050 * rf_dist_km^2) +
           (-0.2710 * rf_avslope_perc) + 
           (0.009394 * rf_dist_km*rf_avslope_perc) + 
           (-0.05135 * sqrt(rf_dist_km) *rf_avslope_perc)
         )

# Calculate GE propensity.
census2$GEpct = exp(census2$logit_ge) / (1 + exp(census2$logit_ge))
```

## BCG construction Step 2: Calculate Government Target Equity (GE) number of cycle commuters for each OD pair.
```{r}
# Calculate future cycle commuter no. based on Government Target Equity (GE) scenario.
census2 =
  census2%>%
  mutate(bicycle_ge = bicycle + all*GEpct)

# Check
sum(census2$bicycle_ge)/sum(census2$bicycle) #1.6 times in total by GE scenario

# Rearrange columns
names(census2)

census2 = 
  census2[,c("omsoa","dmsoa","all","bicycle","bicycle_future","bicycle_gd","bicycle_ge","GDpct","GEpct","logit_gd","logit_ge","rf_dist_km","rf_avslope_perc","intra")]
```

## BCG construction Step 3: Aggregate by destination MSOA.
```{r}
# Aggregate based on destination MSOA.
census3 =
  census2 %>%
  group_by(dmsoa)%>%
  summarise(all = sum(all),
            bicycle = sum(bicycle),
            bicycle_future = sum(bicycle_future),
            bicycle_gd = sum(bicycle_gd),
            bicycle_ge = sum(bicycle_ge)
            )

# How many MSOAs in GL?
length(unique(census2$dmsoa)) #983

# Check
sum(census2$all) == sum(census3$all) # TRUE
sum(census2$bicycle) == sum(census3$bicycle) # TRUE
sum(census2$bicycle_future) == sum(census3$bicycle_future) # TRUE
sum(census2$bicycle_gd) == sum(census3$bicycle_gd) # TRUE
sum(census2$bicycle_ge) == sum(census3$bicycle_ge) # TRUE

```

## BCG construction Step 5: Construct BCG by mean values - Growth amount version
```{r}
# Calculate growth amount and add a new column.
census3$GrowthNosGE = census3$bicycle_ge - census3$bicycle

# Horizontal axis (Current AT share)
# If the share is lower than the mean, 1 otherwise 2.

BCG_x = ifelse(
  census3$CurrentShare < mean(census3$CurrentShare),
  1,2)

# Vertical axis (Growth AT share)
# If the share is lower than the mean, 1 otherwise 2.

BCG_y = ifelse(
  census3$GrowthNosGE < mean(census3$GrowthNosGE),
  1,2)

# Combine the above two.
BCG = paste(BCG_x,BCG_y,sep="")

# Rename the codes to BCG terms.
BCG = recode(BCG, 
              '11' = "Problematic", 
              '12' = "Promising",
              '21' = "Achieved",
              '22' = "Maturing")

# Add a column.
census3$BCGNosGE = BCG

census3$BCGNosGE = factor(census3$BCGNosGE, 
                levels = c("Achieved","Maturing","Promising","Problematic"))

census3%>%
  select(GrowthNosGE,BCGNosGE)%>%
  filter(census3$GrowthNosGE > mean(census3$GrowthNosGE))%>%
  group_by(BCGNosGE)%>%
  summarise(n())
```

## Parking 1: Aggregate parking space for each MSOA
```{r}
# the updated parking data
sum(parking$space) #140788

# Aggregate parking capacity based on MSOA
parking2 =
  parking %>%
  select(msoa, space) %>%
  group_by(msoa) %>%
  summarise(space = sum(space))

sum(parking2$space) == sum(parking$space) #140788 TRUE
```

## Parking 2: Join parking space to census
```{r}
census3 = left_join(census3, parking2, by = c("dmsoa" = "msoa"))
sum(census3$space) == sum(parking2$space) #TRUE Successful!
```

# Parking Occupancy Rate: por

4 Categories:
Surplus  : Less than 50% occupancy rate
Ideal    : 50% and more and 80% and less occupancy rate
Threshold: More than 80% and 100% and less occupancy rate
Shortage : More than 100% occupancy rate

Examples:
Surplus  : bicycle= 30, parking=100 - Less than 50% occupancy rate
Ideal    : bicycle= 70, parking=100 - 50% and more and 80% and less occupancy rate
Threshold: bicycle= 90, parking=100 - More than 80% and 100% and less occupancy rate
Shortage : bicycle=110, parking=100 - More than 100% occupancy rate

Exceptions:
Case 1   : bicycle= 0, parking=100 -> Surplus  (n = 22 current)
Case 2   : bicycle=10, parking=0   -> Shortage (n = 1  current)
Case 3   : bicycle= 0, parking=0   -> Shortage (n = 0  observation)

## Current Occupancy Rate and Category
```{r}
# Current Occupancy Rate
census3$porCurrent = census3$bicycle / census3$space

census3%>%
  filter(bicycle == 0)
census3%>%
  filter(space == 0)

# Categorise into 4.
## 2011 Occupancy Rate
census3 = 
  census3 %>%
    mutate(porCurrentCat = ifelse(porCurrent > 1, "Shortage", 
                          ifelse(0.8 < porCurrent & porCurrent <= 1, "Threshold",
                                 ifelse(0.5 <= porCurrent & porCurrent <= 0.8, "Ideal",
                                        ifelse(0.5 > porCurrent, "Surplus",NA))))
           )
census3
```

## Future Occupancy Rate and Category for Go Dutch (GD) scenario and government target equity (GE) scenario
```{r}
# Future Occupancy Rate GD
census3$porFutureGD = census3$bicycle_future / census3$space

# Categorise into 4.
## 2011 Occupancy Rate GD
census3 = 
  census3 %>%
    mutate(porFutureGDCat = ifelse(porFutureGD > 1, "Shortage", 
                          ifelse(0.8 < porFutureGD & porFutureGD <= 1, "Threshold",
                                 ifelse(0.5 <= porFutureGD & porFutureGD <= 0.8, "Ideal",
                                        ifelse(0.5 > porFutureGD, "Surplus",NA))))
           )

# Future Occupancy Rate GE
census3$porFutureGE = census3$bicycle_ge / census3$space

# Categorise into 4.
## 2011 Occupancy Rate GE
census3 = 
  census3 %>%
    mutate(porFutureGECat = ifelse(porFutureGE > 1, "Shortage", 
                          ifelse(0.8 < porFutureGE & porFutureGE <= 1, "Threshold",
                                 ifelse(0.5 <= porFutureGE & porFutureGE <= 0.8, "Ideal",
                                        ifelse(0.5 > porFutureGE, "Surplus",NA))))
           )

census3$porFutureGDCat = factor(census3$porFutureGDCat, 
                levels = c("Surplus","Ideal","Threshold","Shortage"))

census3$porFutureGECat = factor(census3$porFutureGECat, 
                levels = c("Surplus","Ideal","Threshold","Shortage"))

census3
```

## por checking
```{r}
### Check data
census3 %>%
  group_by(porCurrentCat)%>%
  summarise(n())

census3 %>%
  group_by(porFutureCat)%>%
  summarise(n())

nrow(census3) #983

census3 %>%
  group_by(porCurrentCat)%>%
  summarise(n = n())%>%
  select(n)%>%
  sum() #983

census3 %>%
  group_by(porFutureCat)%>%
  summarise(n = n())%>%
  select(n)%>%
  sum() #983
```

## Reorder factor of por categorisation
```{r}
# Convert to factor.
census3$porCurrentCat = as.factor(census3$porCurrentCat)
census3$porFutureCat  = as.factor(census3$porFutureCat)

# Check levels
levels(census3$porCurrentCat)
levels(census3$porFutureCat)
#"Ideal"     "Shortage"  "Surplus"   "Threshold"

# Reorder factor levels
census3$porCurrentCat = factor(census3$porCurrentCat, 
                levels = c("Surplus","Ideal","Threshold","Shortage"))
census3$porFutureCat = factor(census3$porFutureCat, 
                levels = c("Surplus","Ideal","Threshold","Shortage"))


# Check levels
levels(census3$porCurrentCat)
levels(census3$porFutureCat)
#"Surplus"   "Ideal"     "Threshold" "Shortage" 
```

## Join census 3 dataframe to shapefile msoa
```{r}
msoa = left_join(msoa,census3, by = c("msoa" = "dmsoa"))
```

# Set Up
```{r}
display.brewer.pal(n = 11, name = "RdYlBu") 
brewer.pal(n = 11, name = "RdYlBu") 

BCGcol = c( "#73d87d", "#368cd3", "#FEC44F", "#ff3b40")
col_pocu = c("#4575B4", "#74ADD1", "#FEE090", "#D73027")
```

# Figures

### Figure x Facet map of current and growth nos of cyclist
```{r}
tm_shape(msoa) +
  tm_polygons(col = c("bicycle","GrowthNosGE"),
              style = "fixed",
              breaks = c(0,10,10^2,10^3,10^4,21982),
              palette = brewer.pal(n = 5, name = "YlOrRd"),
              title = c("Current Number of\nCycle Commuters'\nArrival",
                        "Growth Number of\nCycle Commuters'\nArrival"),
              )+
  tm_layout(legend.title.size = 0.9,
            legend.text.size = 0.5,
            legend.position = c("right","bottom"),
            ) +
    tm_facets(sync = TRUE, ncol = 2)


sum(msoa$all) #3145728
sum(msoa$bicycle) #143182
sum(msoa$bicycle)/sum(msoa$all)*100 #4.551633
sum(msoa$bicycle_future) #613945.6
sum(msoa$bicycle_future) - sum(msoa$bicycle) #470763.6
sum(msoa$bicycle_future)/sum(msoa$all)*100 #19.5168
19.5168/4.551633
```

### Figure x Facet map of current and future share of cyclist
```{r}
# Select colors from a palette.
display.brewer.all(colorblindFriendly = TRUE) # display all colorblind-friendly colors


msoa$CurrentSharePct = msoa$CurrentShare*100 #Create new column

tm_shape(msoa) +
  tm_polygons(col = c("CurrentSharePct"),
              style = "fixed",
              breaks = c(0,2,4,6,9,15),
              palette = brewer.pal(n = 5, name = "PuBu"),
              title = c("Current Share of\nCycle Commuter"),
              legend.format=list(fun=function(x) paste0(formatC(x, digits=0, format="f"), "%"))
              )+
  tm_layout(legend.title.size = 0.8,
            legend.text.size = 0.7,
            legend.position = c("right","bottom"),
            ) 

msoa = msoa[-c(which(colnames(msoa)=="CurrentSharePct" ))] # Delete created column 

```

### Figure 16-1-1 Scatter Plot of Growth and Current Share of Cycle Commuter - Growth Amount Vesion Log scale
```{r,fig.width = 10, fig.asp = 1}
test = ggplot(census3, aes(x = CurrentShare, y = GrowthNos)) +
  geom_point(aes(color = BCGNos), size = 1.2, show.legend = FALSE) +
  scale_colour_manual(values=BCGcol) + 
  labs(colour = "Mode Share Matrix Quadrants")+
  labs(y="Growth Amount of Cycle Commuter", x = "Current Commuter Cycling Mode Share")+
  scale_x_continuous(labels = scales::percent_format(accuracy = 1))

test + scale_y_continuous(trans = 'log10')+ 
  geom_line(aes(x = mean(CurrentShare))) +
  geom_line(aes(y = mean(GrowthNos))) +
  geom_text(aes(x = 0.13, y = 550, label = "Mean value = 478", family = "sans")) +
  geom_text(aes(x = 0.035, y = 25000, label = "Mean value = 3.5%", family = "sans")) +
  geom_text(aes(x = 0.06, y = 100, label = "Achieved", family = "sans")) +
  geom_text(aes(x = 0.06, y = 1500, label = "Maturing", family = "sans")) +
  geom_text(aes(x = 0.01, y = 1500, label = "Promising", family = "sans")) +
  geom_text(aes(x = 0.01, y = 100, label = "Problematic", family = "sans")) 
```

### Figure 18 Spatial Distribution of BCG Categories
```{r}
tm_shape(msoa) +
  tm_polygons(col = "BCGNos", palette = BCGcol,
              title = "Mode Share\nMatrix Quadrants")+
  tm_layout(legend.title.size = 1,
            legend.text.size = 0.75,
            legend.position = c("right","bottom"),
            ) 
```

### Figure 22 Spatial Distribution of Cycle Parking Supply
```{r}
tm_shape(msoa) +
  tm_polygons(col = "space",
              style = "fixed",
              breaks = c(0, 100, 300, 600, 1000, 1500, 3010),
              palette = brewer.pal(n = 5, name = "BuGn"),
              title = "Parking Supply")+
  tm_layout(legend.title.size = 1,
            legend.text.size = 0.75,
            legend.position = c("right","bottom"),
            ) 

display.brewer.all(colorblindFriendly = TRUE) # display all colorblind-friendly colors
display.brewer.pal(n = 5, name = "RdYlBu") # Pick 2nd, 4th, 6th and 11th.

tm_shape(msoa) +
  tm_polygons(col = c("CurrentSharePct"),
              style = "fixed",
              breaks = c(0,2,4,6,9,15),
              palette = brewer.pal(n = 5, name = "PuBu"),
              title = c("Current Share of\nCycle Commuter"),
              legend.format=list(fun=function(x) paste0(formatC(x, digits=0, format="f"), "%"))
              )+
  tm_layout(legend.title.size = 0.8,
            legend.text.size = 0.7,
            legend.position = c("right","bottom"),
            ) 
```

### Stats for Parking Supply
```{r}
sum(msoa$bicycle) #143182

# Obtain area of each MSOA
msoa$area = st_area(msoa)

# TOP MSOAS
# Select MSOAs with more than 1000 cycle parkings
msoa %>%
  as.data.frame()%>%
  select(msoa, space)%>%
  arrange(desc(space))%>%
  filter(space>1000)%>% 
  nrow()#13
# These are 13 MSOAs

msoa %>%
  as.data.frame()%>%
  select(msoa, space,area)%>%
  arrange(desc(space))%>%
  filter(space>1000)%>%
  select(space)%>%
  sum()/sum(msoa$space)*100 #13.9742 
# Total of cycle parking at these MSOAs account for 14% of all cycle parkings in Greater London.

msoa %>%
  as.data.frame()%>%
  select(msoa, space,area)%>%
  arrange(desc(space))%>%
  filter(space>1000)%>%
  select(area)%>%
  sum()/sum(msoa$area)*100 #1.472863  
# Total of area of these MSOAs account for 1% of Greater London area.

# BOTTOM MSOAS
# Select MSOAs with less than 100 cycle parkings
msoa %>%
  as.data.frame()%>%
  select(msoa, space)%>%
  arrange(desc(space))%>%
  filter(space<100)%>% 
  nrow()#579
# These are 579 MSOAs

msoa %>%
  as.data.frame()%>%
  select(msoa, space,area)%>%
  arrange(desc(space))%>%
  filter(space<100)%>%
  select(space)%>%
  sum()/sum(msoa$space)*100 #17.61514 
# Total of cycle parking at these MSOAs account for 14% of all cycle parkings in Greater London.

msoa %>% 
  as.data.frame()%>%
  select(msoa, space,area)%>%
  arrange(desc(space))%>%
  filter(space<100)%>%
  select(area)%>%
  sum()/sum(msoa$area)*100 #67.19098   
# Total of area of these MSOAs account for 67% of Greater London area.

msoa = msoa[-c(which(colnames(msoa)=="area" ))] # Delete created column 
```

### Figure 29 Spatial Distribution of Parking Occupancy Category for Current Scenario
```{r}
tm_shape(msoa) +
  tm_polygons(col = "porCurrentCat", 
              palette = col_pocu,
              title = "Current\nParking\nOccupancy")+
  tm_layout(legend.title.size = 1,
            legend.text.size = 0.75,
            legend.position = c("right","bottom"),
            ) 

tm_shape(msoa) +
  tm_polygons(col = "porFutureGDCat", 
              palette = col_pocu,
              title = "Future GoDutch\nParking\nOccupancy")+
  tm_layout(legend.title.size = 1,
            legend.text.size = 0.75,
            legend.position = c("right","bottom"),
            ) 

tm_shape(msoa) +
  tm_polygons(col = "porFutureGECat", 
              palette = col_pocu,
              title = "Future\nGovernment\nTarget (Equity)\nParking\nOccupancy")+
  tm_layout(legend.title.size = 1,
            legend.text.size = 0.75,
            legend.position = c("right","bottom"),
            ) 

tm_shape(msoa) +
  tm_polygons(col = "porCurrent", 
              style = "fixed",
              breaks = c(0, 0.5, 0.8, 1, 2, 10, 1000),
              palette = get_brewer_pal("Spectral", n = 6, contrast = c(0, 0.75)),
              title = "Current\nParking\nOccupancy")+
  tm_layout(legend.title.size = 1,
            legend.text.size = 0.75,
            legend.position = c("right","bottom"),
            ) 
```
### Figure x Number of cyclists destined to each category of parking occupancy
```{r,fig.width = 5, fig.asp = 0.7}
ggplot(census3,aes(fill=porCurrentCat, x = porCurrentCat, y = bicycle)) +
  geom_bar( stat="identity")+
  scale_fill_manual(values=col_pocu)+
  labs(y="No. of Commuter by Bicycle", x = "Parking Occupancy Category")

# Statistics of the number of cyclists destined to each occupancy rate category
census3 %>%
  group_by(porCurrentCat)%>%
  summarise(bicycle = sum(bicycle))%>%
  mutate(pct = bicycle/sum(bicycle)*100)

census3 %>%
  filter(space > 0)%>%
  select(porCurrent, bicycle, space,porCurrentCat)%>%
  summarise(mean= mean(porCurrent), sd=sd(porCurrent))
```

### BCG Growth Number version
### Figure 31-1 Breakdown of Parking Occupancy Category based on No. of Cyclist for Current Scenario (left) and Future Scenario (right)
### Figure 32-1 Percentage Breakdown of Parking Occupancy Category based on No. of Cyclist for Current Scenario (left) and Future Scenario (right)
```{r,fig.width = 5, fig.asp = 0.7}
# Current scenario
tbd =
  census3 %>%
  group_by(BCGNos, porCurrentCat) %>%
    summarise(count = n(), cyclists = sum(bicycle))

# Count Stacked barchart
ggplot(tbd, aes(fill=porCurrentCat, y=cyclists, x=BCGNos))  + 
    geom_bar(position="stack", stat="identity")+
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

# Percent stacked barchart
ggplot(tbd, aes(fill=porCurrentCat, y=cyclists, x=BCGNos))  + 
    geom_bar(position="fill",  stat="identity", ) +
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))

# Stats - No. of cyclists destined to each mode share matrix.
census3 %>%
  group_by(BCGNos)%>%
  summarise(bicycle = sum(bicycle))%>%
  mutate(pct = bicycle/sum(bicycle)*100)

# Stats - BCG x POR
tbd %>%
  group_by(BCGNos)%>%
  mutate(pct = cyclists/sum(cyclists)*100)

```

```{r,fig.width = 5, fig.asp = 0.7}
# Future scenario
# Group by BCG and parking availability category based on GoDutch
tbd =
  census3 %>%
  group_by(BCGNos, porFutureGDCat) %>%
    summarise(count = n(), cyclists = sum(bicycle_future))

# Count Stacked barchart
ggplot(tbd, aes(fill=porFutureGDCat, y=cyclists, x=BCGNos))  + 
    geom_bar(position="stack", stat="identity")+
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

# Percent stacked barchart
ggplot(tbd, aes(fill=porFutureGDCat, y=cyclists, x=BCGNos))  + 
    geom_bar(position="fill",  stat="identity", ) +
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

```

### BCG Growth Number based on Govt Target Equity (GE) version
### Figure 31-1 Breakdown of Parking Occupancy Category based on No. of Cyclist for Current Scenario (left) and Future Scenario (right)
### Figure 32-1 Percentage Breakdown of Parking Occupancy Category based on No. of Cyclist for Current Scenario (left) and Future Scenario (right)
```{r,fig.width = 5, fig.asp = 0.7}
# Current scenario
tbd =
  census3 %>%
  group_by(BCGNosGE, porCurrentCat) %>%
    summarise(count = n(), cyclists = sum(bicycle))

# Count Stacked barchart
ggplot(tbd, aes(fill=porCurrentCat, y=cyclists, x=BCGNosGE))  + 
    geom_bar(position="stack", stat="identity")+
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

# Percent stacked barchart
ggplot(tbd, aes(fill=porCurrentCat, y=cyclists, x=BCGNosGE))  + 
    geom_bar(position="fill",  stat="identity", ) +
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

# Stats - No. of cyclists destined to each mode share matrix.
census3 %>%
  group_by(BCGNosGE)%>%
  summarise(bicycle = sum(bicycle))%>%
  mutate(pct = bicycle/sum(bicycle)*100)

# Stats - BCG x POR
tbd %>%
  group_by(BCGNosGE)%>%
  mutate(pct = cyclists/sum(cyclists)*100)

```

```{r,fig.width = 5, fig.asp = 0.7}
# Future scenario
# Group by BCG and parking availability category based on GE
tbd =
  census3 %>%
  group_by(BCGNosGE, porFutureGECat) %>%
    summarise(count = n(), cyclists = sum(bicycle_ge))

# Count Stacked barchart
ggplot(tbd, aes(fill=porFutureGECat, y=cyclists, x=BCGNosGE))  + 
    geom_bar(position="stack", stat="identity")+
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

# Percent stacked barchart
ggplot(tbd, aes(fill=porFutureGECat, y=cyclists, x=BCGNosGE))  + 
    geom_bar(position="fill",  stat="identity", ) +
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

```
## Color setting
### Revise colors for mode share matrix.
Reference:
https://www.datanovia.com/en/blog/the-a-z-of-rcolorbrewer-palette/
```{r}
BCGcol # Current colors
barplot(c(5,5,5,5), col=BCGcol) # Display colors blue, green, yellow and red

# Select colors from a palette.
display.brewer.all(colorblindFriendly = TRUE) # display all colorblind-friendly colors
display.brewer.pal(n = 12, name = "Paired") # Pick 4th, 2nd, 6th and 11th.
BCGcol = brewer.pal(n = 12, name = "Paired")
BCGcol = BCGcol[c(4,2,11,6)]
barplot(c(5,5,5,5), col=BCGcol) # Check
```

### Revise colors for parking occupancy category.
```{r}
col_pocu # Current colors
barplot(c(5,5,5,5), col=col_pocu) # Display colors blue, green, yellow and red

# Select colors from a palette.
display.brewer.all(colorblindFriendly = TRUE) # display all colorblind-friendly colors
display.brewer.pal(n = 12, name = "Paired") 
display.brewer.pal(n = 8, name = "Dark2") 

col_pocu = brewer.pal(n = 8, name = "Dark2")
col_pocu = col_pocu[c(3,5,2,4)]
barplot(c(5,5,5,5), col=col_pocu) # Check
```

### Figure 21 Breakdown of Parking Space by No. of Cycle Commuter (left) and Area (right)
```{r}
# Join area to census 3.
census3 = left_join(census3, area, by = c("dmsoa" = "msoa"))
```

```{r, fig.width = 5, fig.asp = 0.8}
# Categorise into 6 ranges.
tbd= 
  census3 %>%
  mutate(space2 = ifelse(space == 0, "None", 
                          ifelse(1 <= space & space <= 100, "1-100",
                                 ifelse(100 < space & space <= 300, "100-300",
                                        ifelse(300 < space & space <= 500, "300-500",
                                               ifelse(500 < space & space <= 1000, "500-1000",
                                                      ifelse(1000 < space,"1000-",NA))))))
           )

tbd2= tbd %>%
  group_by(space2)%>%
  summarise(all = sum(all), bicycle = sum(bicycle),area = sum(area_sqm))

tbd2$space2 = as.factor(tbd2$space2)
levels(tbd2$space2)
tbd2$space2 = factor(tbd2$space2, 
                levels = c("None","1-100","100-300","300-500","500-1000","1000-"))

tbd2$area_kmsq = tbd2$area/1000^2
tbd2$area_kmsq = as.numeric(tbd2$area_kmsq)

# Size in terms of area
(1002575971+ 65723076 )/ 1573508480  #0.6789281 by small numbers

31713098 / 1573508480 #0.02015439

# Size in terms of cyclist
(511+ 21666 )/ 143182  #0.1548868 by small numbers

sum(tbd2$bicycle)
45138 / 143182 #0.3152491

  

ggplot(tbd2,aes(x=space2, y = all)) +
  geom_bar( stat="identity")+
  labs(y="No. of Commuter by All Modes", x = "Parking Space")

ggplot(tbd2,aes(x=space2, y = bicycle)) +
  geom_bar( stat="identity")+
  labs(y="No. of Commuter by Bicycle", x = "Parking Space")

ggplot(tbd2,aes(x=space2, y = area_kmsq)) +
  geom_bar( stat="identity")+
  labs(y="Area (sq.km)", x = "Parking Space")
```


### Figure 25 Spatial Distribution of Current Parking Space Demand
```{r}
tm_shape(msoa) +
  tm_polygons(col = "bicycle",
              style = "fixed",
              breaks = c(0, 134, 176, 217, 270, 336, 420, 508, 718, 1074, 13053),
              legend.hist = TRUE,
              palette = get_brewer_pal("Spectral", n = 10, contrast = c(0, 0.75)),
              title = "Current Parking \nDemand")+
  tm_layout(legend.outside = TRUE) +
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))
```

### Figure 26 Increased Amount (left) and Increased Rate (right) of Parking Demand
```{r}
tbd = msoa[,c("bicycle", "bicycle_future")]
tbd$increasedAmount = tbd$bicycle_future - tbd$bicycle
tbd$increasedRate = tbd$bicycle_future/tbd$bicycle

tm_shape(tbd) +
  tm_polygons(col = "increasedAmount",
              style = "fixed",
              breaks = c(31, 152, 228, 250, 568, 21982),
              legend.hist = TRUE,
              palette = get_brewer_pal("Spectral", n = 5, contrast = c(0, 0.75)),
              title = "Parking Demand\n Growth\n(Future - Current)")+
  tm_layout(legend.outside = TRUE) +
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))

tm_shape(tbd) +
  tm_polygons(col = "increasedRate",
              style = "fixed",
              breaks = c(1.6, 4, 7, 10, 15,109),
              legend.hist = TRUE,
              palette = get_brewer_pal("Spectral", n = 5, contrast = c(0, 0.75)),
              title = "Parking Demand\n Growth\n(Future/Current)")+
  tm_layout(legend.outside = TRUE) +
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))
```

### Figure 28 Spatial Distribution of Future Parking Capacity Demand
```{r}
tm_shape(msoa) +
  tm_polygons(col = "bicycle_future",
              style = "fixed",
              breaks = c(34, 134, 176, 217, 270, 336, 420, 508, 718, 1074, 35035),
              legend.hist = TRUE,
              palette = get_brewer_pal("Spectral", n = 10, contrast = c(0, 0.75)),
              title = "Future Parking\n Demand")+
  tm_layout(legend.outside = TRUE)

```

### Figure 30 Spatial Distribution of Parking Occupancy Category for Future Scenario
```{r}
tm_shape(msoa) +
  tm_polygons(col = "porFutureCat", 
              palette = col_pocu,
              title = "Future \n Parking Occupancy")+
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))

```

### BCG Growth share version
### Figure 31 Breakdown of Parking Occupancy Category based on No. of Cyclist for Current Scenario (left) and Future Scenario (right)
### Figure 32 Percentage Breakdown of Parking Occupancy Category based on No. of Cyclist for Current Scenario (left) and Future Scenario (right)
```{r,fig.width = 5, fig.asp = 0.7}
# Current scenario
tbd =
  census3 %>%
  group_by(BCG, porCurrentCat) %>%
    summarise(count = n(), cyclists = sum(bicycle))

# Count Stacked barchart
ggplot(tbd, aes(fill=porCurrentCat, y=cyclists, x=BCG))  + 
    geom_bar(position="stack", stat="identity")+
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

# Percent stacked barchart
ggplot(tbd, aes(fill=porCurrentCat, y=cyclists, x=BCG))  + 
    geom_bar(position="fill",  stat="identity", ) +
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

```

```{r,fig.width = 5, fig.asp = 0.7}
# Future scenario
# Group by BCG and parking availability category based on GoDutch
tbd =
  census3 %>%
  group_by(BCG, porFutureCat) %>%
    summarise(count = n(), cyclists = sum(bicycle_future))

# Count Stacked barchart
ggplot(tbd, aes(fill=porFutureCat, y=cyclists, x=BCG))  + 
    geom_bar(position="stack", stat="identity")+
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

# Percent stacked barchart
ggplot(tbd, aes(fill=porFutureCat, y=cyclists, x=BCG))  + 
    geom_bar(position="fill",  stat="identity", ) +
  scale_fill_manual(values=col_pocu)+
  labs(fill = "Parking\n Occupancy")+
  labs(y="No. of Cyclist", x = "Mode Share Matrix Quadrants")

```


### Figure 33 Scatter Plot of Parking Space and No. of Cyclist by MSOA for Current Scenario 
```{r,fig.width = 10, fig.asp = 0.25}
ggplot(census3, 
       aes(x = bicycle, 
           y = space,
           color = BCG)
       )+
  geom_point(size = 1) +
  scale_colour_manual(values=BCGcol) +
  geom_abline(intercept = 0, 
              slope = 1, 
              color="red", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1
  geom_abline(intercept = 0, 
              slope = 1.25, 
              color="black", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1.2
  geom_abline(intercept = 0, 
              slope = 2, 
              color="blue", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:2
  xlim(0,NA)+
  ylim(0,NA)+
  facet_wrap( ~ BCG, ncol=4)+
  labs(y="Parking Capacity", x = "Current No. of Cycle Commuter")
```

```{r,fig.width = 10, fig.asp = 0.25}
ggplot(census3, 
       aes(x = bicycle, 
           y = space,
           color = BCG)
       )+
  geom_point(size = 1) +
  scale_colour_manual(values=BCGcol) +
  geom_abline(intercept = 0, 
              slope = 1, 
              color="red", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1
  geom_abline(intercept = 0, 
              slope = 1.25, 
              color="black", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1.2
  geom_abline(intercept = 0, 
              slope = 2, 
              color="blue", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:2
  xlim(0,1000)+
  ylim(0,500)+
  facet_wrap( ~ BCG, ncol=4)+
  labs(y="Parking Capacity", x = "Current No. of Cycle Commuter")
```

### Figure 33-1 Scatter Plot of Parking Space and No. of Cyclist by MSOA for Current Scenario LOG SCALE! - Growth Share Version
```{r,fig.width = 10, fig.asp = 0.25}
test = ggplot(census3, 
       aes(x = bicycle, 
           y = space,
           color = BCG)
       )+
  geom_point(size = 1) +
  scale_colour_manual(values=BCGcol) +
  geom_abline(intercept = 0, 
              slope = 1, 
              color="red", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1
  geom_abline(intercept = 0, 
              slope = 1.25, 
              color="black", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1.2
  geom_abline(intercept = 0, 
              slope = 2, 
              color="blue", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:2
  xlim(0,NA)+
  ylim(0,NA)+
  facet_wrap( ~ BCG, ncol=4)+
  labs(y="Parking Capacity", x = "Current No. of Cycle Commuter")

test + scale_x_continuous(trans = 'log10') +  scale_y_continuous(trans = 'log10')

```

### Figure 33-1-1 Scatter Plot of Parking Space and No. of Cyclist by MSOA for Current Scenario LOG SCALE! - Growth Number Version
```{r,fig.width = 10, fig.asp = 0.25}
test = ggplot(census3, 
       aes(x = bicycle, 
           y = space,
           color = BCGNos)
       )+
  geom_point(size = 1) +
  scale_colour_manual(values=BCGcol) +
  geom_abline(intercept = 0, 
              slope = 1, 
              color="red", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1
  geom_abline(intercept = 0, 
              slope = 1.25, 
              color="black", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1.2
  geom_abline(intercept = 0, 
              slope = 2, 
              color="blue", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:2
  xlim(0,1000)+
  ylim(0,500)+
  facet_wrap( ~ BCGNos, ncol=4)+
  labs(y="Parking Capacity", x = "Current No. of Cycle Commuter")

test + scale_x_continuous(trans = 'log10') +  scale_y_continuous(trans = 'log10')
```


### Figure 34 Scatter Plot of Parking Space and No. of Cyclist by MSOA for Future Scenario
```{r,fig.width = 10, fig.asp = 0.25}
# GoDutch - Plot provision of parking per BCG.
ggplot(census3, 
       aes(x = bicycle_future, 
           y = space,
           color = BCG)
       )+
  geom_point(size = 1) +
  scale_colour_manual(values=BCGcol) +
  geom_abline(intercept = 0, 
              slope = 1, 
              color="red", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1
  geom_abline(intercept = 0, 
              slope = 1.25, 
              color="black", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1.2
  geom_abline(intercept = 0, 
              slope = 2, 
              color="blue", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:2
  xlim(0,NA)+
  ylim(0,NA)+
  facet_wrap( ~ BCG, ncol=4)+
  labs(y="Parking Capacity", x = "Future No. of Cycle Commuter")
```

```{r,fig.width = 10, fig.asp = 0.25}
# GoDutch - Plot provision of parking per BCG.
ggplot(census3, 
       aes(x = bicycle_future, 
           y = space,
           color = BCG)
       )+
  geom_point(size = 1) +
  scale_colour_manual(values=BCGcol) +
  geom_abline(intercept = 0, 
              slope = 1, 
              color="red", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1
  geom_abline(intercept = 0, 
              slope = 1.25, 
              color="black", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1.2
  geom_abline(intercept = 0, 
              slope = 2, 
              color="blue", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:2
  xlim(0,1000)+
  ylim(0,500)+
  facet_wrap( ~ BCG, ncol=4)+
  labs(y="Parking Capacity", x = "Future No. of Cycle Commuter")
```

### Figure 34-1 Scatter Plot of Parking Space and No. of Cyclist by MSOA for Future Scenario - Growth Share Version
```{r,fig.width = 10, fig.asp = 0.25}
# GoDutch - Plot provision of parking per BCG.
test = ggplot(census3, 
       aes(x = bicycle_future, 
           y = space,
           color = BCG)
       )+
  geom_point(size = 1) +
  scale_colour_manual(values=BCGcol) +
  geom_abline(intercept = 0, 
              slope = 1, 
              color="red", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1
  geom_abline(intercept = 0, 
              slope = 1.25, 
              color="black", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1.2
  geom_abline(intercept = 0, 
              slope = 2, 
              color="blue", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:2
  xlim(0,NA)+
  ylim(0,NA)+
  facet_wrap( ~ BCG, ncol=4)+
  labs(y="Parking Capacity", x = "Future No. of Cycle Commuter")

test + scale_x_continuous(trans = 'log10') +  scale_y_continuous(trans = 'log10')
```


### Figure 34-1-1 Scatter Plot of Parking Space and No. of Cyclist by MSOA for Future Scenario - Growth Number Version
```{r,fig.width = 10, fig.asp = 0.25}
# GoDutch - Plot provision of parking per BCG.
test = ggplot(census3, 
       aes(x = bicycle_future, 
           y = space,
           color = BCGNos)
       )+
  geom_point(size = 1) +
  scale_colour_manual(values=BCGcol) +
  geom_abline(intercept = 0, 
              slope = 1, 
              color="red", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1
  geom_abline(intercept = 0, 
              slope = 1.25, 
              color="black", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:1.2
  geom_abline(intercept = 0, 
              slope = 2, 
              color="blue", 
              linetype="dashed", 
              size=0.5) + # Cyclist:Parking=1:2
  xlim(0,1000)+
  ylim(0,500)+
  facet_wrap( ~ BCGNos, ncol=4)+
  labs(y="Parking Capacity", x = "Future No. of Cycle Commuter")

test + scale_x_continuous(trans = 'log10') +  scale_y_continuous(trans = 'log10')
```

# Government Target Equity 
### Figure 16-1-1 Scatter Plot of Growth and Current Share of Cycle Commuter - Growth Amount Vesion Log scale
```{r,fig.width = 10, fig.asp = 1}
test = ggplot(census3, aes(x = CurrentShare, y = GrowthNosGE)) +
  geom_point(aes(color = BCGNosGE), size = 1) +
  scale_colour_manual(values=BCGcol) + 
  geom_line(aes(x = mean(CurrentShare))) +
  geom_line(aes(y = mean(GrowthNosGE))) +
  labs(colour = "Mode Share Matrix Quadrants")+
  labs(y="Growth Amount of Cycle Commuter", x = "Current Share of Cycle Commuter")+
  geom_label(label = "Mean value = 478",
             x = 0.14,
             y = 450
             )+
  scale_x_continuous(labels = scales::percent_format(accuracy = 1))

mean(census3$CurrentShare) #0.03563695
mean(census3$GrowthNosGE) #101.5944

test + scale_y_continuous(trans = 'log10')

test = ggplot(census3, aes(x = CurrentShare, y = GrowthNosGE)) +
  geom_point(aes(color = BCGNosGE), size = 1.2, show.legend = FALSE) +
  scale_colour_manual(values=BCGcol) + 
  labs(colour = "Mode Share Matrix Quadrants")+
  labs(y="Growth Amount of Cycle Commuter", x = "Current Commuter Cycling Mode Share")+
  scale_x_continuous(labels = scales::percent_format(accuracy = 1))

test + scale_y_continuous(trans = 'log10')+ 
  geom_line(aes(x = mean(CurrentShare))) +
  geom_line(aes(y = mean(GrowthNosGE))) +
  geom_text(aes(x = 0.13, y = 115, label = "Mean value = 102", family = "sans")) +
  geom_text(aes(x = 0.035, y = 7500, label = "Mean value = 3.5%", family = "sans")) +
  geom_text(aes(x = 0.06, y = 30, label = "Achieved", family = "sans")) +
  geom_text(aes(x = 0.06, y = 400, label = "Maturing", family = "sans")) +
  geom_text(aes(x = 0.01, y = 400, label = "Promising", family = "sans")) +
  geom_text(aes(x = 0.01, y = 30, label = "Problematic", family = "sans")) 

```

### Figure 18 Spatial Distribution of BCG Categories
```{r}
tm_shape(msoa) +
  tm_polygons(col = "BCGNosGE", palette = BCGcol,
              title = "Mode Share\nMatrix Quadrants")+
  tm_layout(legend.title.size = 1,
            legend.text.size = 0.75,
            legend.position = c("right","bottom"),
            ) 
```

# ARCHIVE NOT IN USE
```{r}

# Extract current and growth no. of cyclists
msoa1_1 = msoa[c("msoa","bicycle")] 
msoa1_2 = msoa[c("msoa","GrowthNos")]

# Add new column, current or growth
msoa1_1$cat = "current" 
msoa1_2$cat = "growth"

# Rename bicycle and GrowthNos columns
msoa1_1$Nos = msoa1_1$bicycle
msoa1_2$Nos = msoa1_2$GrowthNos

msoa1_1 = msoa1_1[c("msoa","Nos","cat","geometry")]
msoa1_2 = msoa1_2[c("msoa","Nos","cat","geometry")]

# Combine two data frames
msoa2 = rbind(msoa1_1,msoa1_2)

# plot
tm_shape(msoa2) +
  tm_polygons(col = "Nos",
              style = "fixed",
              breaks = c(0,10,10^2,10^3,10^4,21982),
              title = "Number of\nCycle Commuters'\nArrival",
              palette = get_brewer_pal("Spectral", n = 5, contrast = c(0, 0.75)),
              )+
  tm_layout(legend.title.size = 0.9,
            legend.text.size = 0.7,
            panel.labels=c("Current No. of ","Growth"),
            panel.label.color = "black",
            panel.label.size=1
            ) +
  tm_facets(by = c("cat"), ncol = 2)
```

### Figure x Current Number of Cycle Commuters' Arrival
```{r}
tm_shape(msoa) +
  tm_polygons(col = "bicycle",
              style = "fixed",
              breaks = c(0,10,100,1000,10000,13053),
              palette = get_brewer_pal("Spectral", n = 5, contrast = c(0, 0.75)),
              title = "Current Number of\nCycle Commuters'\nArrival",
              )+
  tm_layout(legend.title.size = 0.9,
            legend.text.size = 0.7,
            legend.position = c("right","bottom"),
            )
```

### Figure x Future Number of Cycle Commuters' Arrival
```{r}
tm_shape(msoa) +
  tm_polygons(col = "bicycle_future",
              style = "fixed",
              breaks = c(0,10,10^2,10^3,10^4,35035),
              palette = get_brewer_pal("Spectral", n = 5, contrast = c(0, 0.75)),
              title = "Future Number of\nCycle Commuters'\nArrival",
              )+
  tm_layout(legend.title.size = 0.9,
            legend.text.size = 0.7,
            legend.position = c("right","bottom"),
            )

min(msoa$bicycle_future) #34.61217
max(msoa$bicycle_future) #35034.31
```

### Figure x Growth Number of Cycle Commuters' Arrival
```{r}
tm_shape(msoa) +
  tm_polygons(col = "GrowthNos",
              style = "fixed",
              breaks = c(0,10,10^2,10^3,10^4,21982),
              palette = get_brewer_pal("Spectral", n = 5, contrast = c(0, 0.75)),
              title = "Growth Number of\nCycle Commuters'\nArrival",
              )+
  tm_layout(legend.title.size = 0.9,
            legend.text.size = 0.7,
            legend.position = c("right","bottom"),
            )

min(msoa$GrowthNos) #31.61217
max(msoa$GrowthNos) #21981.31
```

### Figure 11 Destination Based Spatial Distribution of Future Cycle Commuter Share
```{r}
msoa$FutureSharePct = msoa$FutureShare*100 #Create new column

tm_shape(msoa) +
  tm_polygons(col = "FutureSharePct",
              style = "fixed",
              breaks = c(0, 2,4,6,9,15,19,22,24,27,35),
              palette = get_brewer_pal("Spectral", n = 10, contrast = c(0, 0.75)),
              title = "Future Share of\nCycle Commuter",
              legend.format=list(fun=function(x) paste0(formatC(x, digits=0, format="f"), "%"))
              )+
  tm_layout(legend.title.size = 0.9,
            legend.text.size = 0.7,
            legend.position = c("right","bottom"),
            )

msoa = msoa[-c(which(colnames(msoa)=="FutureSharePct" ))] # Delete created column 

sum(msoa$bicycle_future) - sum(msoa$bicycle) #470763.6  

```



### Figure 15 Destination Based Spatial Distribution of Growth Cycle Commuter Share
```{r}
tm_shape(msoa) +
  tm_polygons(col = "Growth",
              style = "fixed",
              breaks = c(0.06, 0.16, 0.18, 0.20, 0.24, 0.33),
              legend.hist = TRUE,
              palette = get_brewer_pal("Spectral", n = 5, contrast = c(0, 0.75)),
              title = "Growth Share \n of Cycle Commuter")+
  tm_layout(legend.outside = TRUE) +
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))

```

### Figure 15-1 Destination Based Spatial Distribution of Growth Nos Cycle Commuter Share
```{r}
tm_shape(msoa) +
  tm_polygons(col = "GrowthNos",
              title = "Growth Number \n of Cycle Commuter")+
  tm_layout(legend.outside = TRUE) +
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))


```

### Figure 15-1-1 Destination Based Spatial Distribution of Growth Nos Cycle Commuter Share LOG SCALE!
```{r}
tm_shape(msoa) +
  tm_polygons(col = "GrowthNos",
              style = "log10_pretty", 
              title = "Growth Number \n of Cycle Commuter")+
  tm_layout(legend.outside = TRUE) +
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))

```

```{r}
tm_shape(msoa) +
  tm_polygons(col = "GrowthNos",
              style = "log10", 
              title = "Growth Number \n of Cycle Commuter")+
  tm_layout(legend.outside = TRUE) +
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))

```

### Figure 16 Scatter Plot of Growth and Current Share of Cycle Commuter
```{r,fig.width = 10, fig.asp = 0.75}
ggplot(census3, aes(x = CurrentShare, y = Growth)) +
  geom_point(aes(color = BCG), size = 1) +
  scale_colour_manual(values=BCGcol) + 
  geom_line(aes(x = mean(CurrentShare))) +
  geom_line(aes(y = mean(Growth))) +
  labs(colour = "Mode Share Matrix Quadrants")+
  labs(y="Growth Share of Cycle Commuter", x = "Current Share of Cycle Commuter")+
  geom_label(label = "Mean value = 0.19",
             x = 0.14,
             y = 0.2
             )+
    geom_label(label = "Mean value = 0.03",
             x = 0.05,
             y = 0.31
             )

mean(census3$CurrentShare)*100 #3.563695
mean(census3$Growth)*100 #19.50014
```

### Figure 16-1 Scatter Plot of Growth and Current Share of Cycle Commuter - Growth Amount Vesion
```{r,fig.width = 10, fig.asp = 0.75}
census3$CurrentSharePct = census3$CurrentShare*100 #Create new column

ggplot(census3, aes(x = CurrentSharePct, y = GrowthNos)) +
  geom_point(aes(color = BCGNos), size = 1) +
  scale_colour_manual(values=BCGcol) + 
  geom_line(aes(x = mean(CurrentSharePct))) +
  geom_line(aes(y = mean(GrowthNos))) +
  labs(colour = "Mode Share Matrix Quadrants")+
  labs(y="Growth Amount of Cycle Commuter", x = "Current Share of Cycle Commuter")

mean(census3$CurrentShare)*100 #3.563695
mean(census3$GrowthNos) #478.905

census3 = census3[-c(which(colnames(census3)=="CurrentSharePct" ))] # Delete created column 

```

